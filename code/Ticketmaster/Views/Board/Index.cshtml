@model Ticketmaster.Models.Board

@{
	ViewData["Title"] = $"{Model.ParentProject?.ProjectName} Board";


	// var inProgress = Model.Stages?.FirstOrDefault(s => s.Position == 1);
	// var todo = Model.Stages?.FirstOrDefault(s => s.Position == 0);
	// var done = Model.Stages?.FirstOrDefault(s => s.Position == 2);
}

<h2>@ViewData["Title"]</h2>

<a asp-action="Create" asp-route-projectId="@Model.ParentProjectId" class="btn btn-primary mb-3">+ Add Stage</a>
@if (Model.Stages == null || !Model.Stages.Any())
{
    <p><em>No stages available. Please add a stage to get started.</em></p>
}
else
{
    <div style="display: flex; gap: 20px;">
        @foreach (var stage in Model.Stages.OrderBy(s => s.Position))
        {
            <div style="flex: 1; background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h3>@stage.StageTitle</h3>
                    <div>
                        <a asp-action="Edit" asp-route-id="@stage.StageId" class="btn btn-sm btn-warning">Edit</a>
                        <a asp-action="Delete" asp-route-id="@stage.StageId" class="btn btn-sm btn-danger">Delete</a>
                    </div>
                </div>

                <!-- Task List -->
                @if (stage?.Tasks?.Any() == true)
                {
                    foreach (var task in stage.Tasks)
                    {
                        <div style="padding: 10px; margin-bottom: 10px; background-color: #fff; border: 1px solid #ccc; border-radius: 4px;">
                            <strong>@task.Title</strong><br />
                            <small>@task.Description</small>

                            <form asp-action="DeleteTask" method="post" class="mt-2">
                                <input type="hidden" name="taskId" value="@task.TaskItemId" />
                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete Task</button>
                            </form>

							<!-- Move Task Button (Triggers Modal) -->
							<button class="btn btn-sm btn-outline-secondary"
									data-task-id="@task.TaskItemId"
									data-current-stage="@stage.StageId"
									data-bs-toggle="modal"
									data-bs-target="#moveTaskModal">
								Move Task
							</button>

                        </div>
                    }
                }
                else
                {
                    <p><em>No tasks yet.</em></p>
                }

                <!-- Add Task Form -->
                <form asp-action="AddTask" method="post" class="mt-3">
                    <input type="hidden" name="stageId" value="@stage.StageId" />
                    <div class="mb-2">
                        <input name="title" class="form-control" placeholder="Task title" required />
                    </div>
                    <div class="mb-2">
                        <input name="description" class="form-control" placeholder="Description (optional)" />
                    </div>
                    <button type="submit" class="btn btn-sm btn-success">+ Add Task</button>
                </form>
            </div>
        }
    </div>

    <!-- Move Task Modal -->
    <div class="modal fade" id="moveTaskModal" tabindex="-1" aria-labelledby="moveTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" asp-action="MoveTask">
                    <div class="modal-header">
                        <h5 class="modal-title" id="moveTaskModalLabel">Move Task to Another Stage</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="taskId" id="moveTaskId" />
                        <div class="mb-3">
                            <label for="targetStageId" class="form-label">Select Target Stage</label>
                            <select class="form-select" id="targetStageId" name="targetStageId" required>
                                @foreach (var s in Model.Stages)
                                {
                                    <option value="@s.StageId">@s.StageTitle</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Move</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        var moveModal = document.getElementById('moveTaskModal');
        moveModal.addEventListener('show.bs.modal', function (event) {
          var button = event.relatedTarget;
          var taskId = button.getAttribute('data-task-id');
          var currentStageId = button.getAttribute('data-current-stage');

          var input = document.getElementById('moveTaskId');
          input.value = taskId;

          var dropdown = document.getElementById('targetStageId');
          Array.from(dropdown.options).forEach(opt => {
            opt.hidden = opt.value === currentStageId;
          });
          dropdown.selectedIndex = Array.from(dropdown.options).findIndex(opt => !opt.hidden);
        });
    </script>
}



@*
			<div style="flex: 1; background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
				<h3>@inProgress?.StageTitle </h3>
				@if (todo?.Tasks?.Any() == true)
				{
					foreach (var task in todo.Tasks)
					{
						<div style="padding: 10px; margin-bottom: 10px; background-color: #fff; border: 1px solid #ccc; border-radius: 4px;">
							<strong>@task.Title</strong><br />
							<small>@task.Description</small>
						</div>
					}
				}
				else
				{
					<p><em>No tasks yet.</em></p>
				}
			</div> *@

@* In Progress *@
@* 			<div style="flex: 1; background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
				<h3>In Progress</h3>
				@if (inProgress?.Tasks?.Any() == true)
				{
					foreach (var task in inProgress.Tasks)
					{
						<div style="padding: 10px; margin-bottom: 10px; background-color: #fff; border: 1px solid #ccc; border-radius: 4px;">
							<strong>@task.Title</strong><br />
							<small>@task.Description</small>
						</div>
					}
				}
				else
				{
					<p><em>No tasks yet.</em></p>
				}
			</div> *@

@* Done *@
@* 			<div style="flex: 1; background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
				<h3>Done</h3>
				@if (done?.Tasks?.Any() == true)
				{
					foreach (var task in done.Tasks)
					{
						<div style="padding: 10px; margin-bottom: 10px; background-color: #fff; border: 1px solid #ccc; border-radius: 4px;">
							<strong>@task.Title</strong><br />
							<small>@task.Description</small>
						</div>
					}
				}
				else
				{
					<p><em>No tasks yet.</em></p>
				}
    </div> *@
